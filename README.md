# DFA (Download files and archive)
## Как работает?

На сервер (*/controller/route.php*) отправляются данные:
1. Список Url, имя архива  (опционально) в формате JSON (для скачивания  и архивирования).
    + Создаётся новый объект класса DFA с данными пришедшими от пользователя и заранее установленной конфигурацией (*/controller/config.php*).
		```php
		$archive = new DFA($data["url"], array_merge($dbconf, $conf));
		```

    + Запускается процесс скачивания файлов.
		```php
		$archive->downloadFile();
		```

    + Архивирование и подготовка ответа (id созданного архива, отклонённые url, готовые url).
		```php
		$response = ["id" => $archive->prepareArchive(), "reject" => $archive->reject(), "ready" => $archive->ready()];
		```

    + Удаление скаченых файлов и ответ.
		```php
		$archive->removeAllFiles();
		echo json_encode($response);
		```

2. Id архива (для отдачи архива).
    + Проверяется способ отдачи файла (настраивается в */controller/config.php*)
    + Вызывается выбранная функция в аргументе которой статический метод (метод возвращает путь до архива)
		```php
		switch (DOWNLOAD_METHOD) {
			case 0:
				responseApache(DFA::download($_GET['id'], $dbconf));
				break;
			case 1:
				responsePHP(DFA::download($_GET['id'], $dbconf));
				break;
			default:
				break;
		}
		```

## Настройка config.php

*config.php* нахидиится в папке *controller* и содержит следующие параметры:
1. Настройка подключения к базе данных
	```php
	$dbconf = [
		"host" => "localhost",
		"dbname" => "dfa",
		"tableName" => "archive", // имя таблицы
		"username" => "root",
		"passwd" => ""
	];
	```
2. Настройка работы системы:
	```php
	$conf = [
		"memory" => null,
		"root" => null,
		"log" => ".." . DIRECTORY_SEPARATOR . "Log",
		"encryption" => 3,
		"compress" => 4,
		"live" => 1200
	];

	define("DOWNLOAD_METHOD", 0);
	```
	**memory** - максимальное количество памяти (в байтах) выделенное под файлы (не включает сам архив)

	**root** - Путь до папки для хранения файлов (по умолчанию "*../TempFiles*")

	**log** - Путь до папки для хранения логов (по умолчанию "*../log*")

	**encryption** - Шифрование архива. Значение от **0** до **3**, где:
	- **0** - Отсутствие шифрования
	- **1** - AES 128
	- **2** - AES 192
	- **3** - AES 256

	**compress** - Сжатие архива. Значение от **0** до **4**, где:
	- **0** - Отсутствие сжатия
	- **1**,**2**,**3**,**4** - Фактор сжатия

	**live** - Срок годности архива. После истечения срока, при запуске очистки, архив будет удалён.

	**DOWNLOAD_METHOD** - Метод скачивания. Значение от **0** до **1**, где:
	- **0** - При помощи *Apache (X-SendFile)*
	- **1** - При помощи *PHP*

## Запуск очистки

Очистка происходит при помощи статического метода:
```php
DFA::remove($dbconf);
```
Запуск скрипта "*/model/clean_up.php*" удалит архивы и запись из базы данных. Скрипт запишет результат в лог по пути "*../log*".<br>
- Имя лога является дата формата "*Y-m-d*".<br>
- Если удалить файл не вышло, запись также удаляется из базы данных.

**ВНИМАНИЕ** - Удаляются только те файлы, запись о которых есть в базе данных.